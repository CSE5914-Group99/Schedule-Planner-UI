<div class="schedule-builder-container">
  <!-- Header -->
  <header class="builder-header">
    <div class="header-left">
      <button class="btn back-btn" (click)="goBack()">‚Üê Back</button>
      <div class="name-input-group">
        <label for="scheduleName" class="name-label">Schedule Name:</label>
        <input
          id="scheduleName"
          type="text"
          class="schedule-name-input"
          [class.error]="errorMessage()?.includes('schedule name')"
          [value]="schedule()?.name || ''"
          (input)="updateScheduleName($any($event.target).value)"
          placeholder="Enter schedule name (required)"
        />
      </div>
    </div>
    <div class="header-right">
      @if (hasUnsavedChanges()) {
        <span class="unsaved-indicator">‚óè Unsaved changes</span>
      }
      <button class="btn save-btn" (click)="saveSchedule()" [disabled]="saving()">
        @if (saving()) {
          Saving...
        } @else {
          üíæ Save Schedule
        }
      </button>
    </div>
  </header>

  @if (errorMessage()) {
    <div class="error-message">
      {{ errorMessage() }}
    </div>
  }

  <!-- Generated Schedule Tabs -->
  @if (isGeneratedMode()) {
    <div class="generated-tabs-container">
      <div class="tabs-header">
        <span class="tabs-label">Generated Options:</span>
        <div class="tabs-list">
          @for (sched of generatedSchedules(); track $index) {
            <button 
                class="tab-btn" 
                [class.active]="selectedGeneratedIndex() === $index"
                (click)="selectGeneratedSchedule($index)">
                Option {{ $index + 1 }}
                @if (sched.difficultyScore) {
                    <span class="score-badge">{{ sched.difficultyScore | number:'1.1-1' }}</span>
                }
            </button>
          }
        </div>
      </div>
      <div class="tabs-actions">
        <button class="btn discard-btn" (click)="discardGeneratedSchedule()">Discard</button>
        <button class="btn secondary-btn" (click)="openAnalyzer()" [disabled]="analyzing()">
          @if (analyzing()) {
            üìä Analyzing...
          } @else {
            üìä Analyze
          }
        </button>
        <button class="btn accept-btn" (click)="acceptGeneratedSchedule()">‚úì Keep This Schedule</button>
      </div>
    </div>
  }

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-section">
      <button class="btn primary-btn" (click)="openCourseDialog()" [disabled]="isGeneratedMode()">+ Add Course</button>
      <button class="btn secondary-btn" (click)="openEventDialog()" [disabled]="isGeneratedMode()">+ Add Event</button>
      <button class="btn generate-btn" (click)="generateSchedule()" [disabled]="generating() || isGeneratedMode()">
        @if (generating()) {
          ‚ú® Generating...
        } @else {
          ‚ú® Generate
        }
      </button>
    </div>

    <div class="toolbar-section">
      <label>
        Campus:
        <select
          class="dropdown"
          [value]="selectedCampus()"
          (change)="selectedCampus.set($any($event.target).value)"
        >
          <option *ngFor="let campus of campuses" [value]="campus">{{ campus }}</option>
        </select>
      </label>

      <label>
        Term:
        <select
          class="dropdown"
          [value]="selectedTerm()"
          (change)="selectedTerm.set($any($event.target).value)"
        >
          <option *ngFor="let term of terms" [value]="term">{{ term }}</option>
        </select>
      </label>
      <label>
        Start Hour:
        <input
          type="number"
          min="0"
          max="23"
          [value]="startHour()"
          (change)="startHour.set(+$any($event.target).value); updateTimeRange()"
          class="time-input"
        />
      </label>
      <label>
        End Hour:
        <input
          type="number"
          min="0"
          max="23"
          [value]="endHour()"
          (change)="endHour.set(+$any($event.target).value); updateTimeRange()"
          class="time-input"
        />
      </label>
      <label class="checkbox-label">
        <input type="checkbox" [checked]="showWeekend()" (change)="toggleWeekend()" />
        Show Weekend
      </label>
    </div>
  </div>

  <!-- Calendar Grid -->
  @if (schedule()) {
    <div class="calendar-layout">
      <div class="calendar-container">
        <div
          class="calendar-grid"
          [style.grid-template-columns]="'80px repeat(' + visibleDays().length + ', 1fr)'"
        >
          <!-- Header Row -->
          <div class="calendar-cell header-cell corner-cell">Time</div>
          @for (day of visibleDays(); track day) {
            <div class="calendar-cell header-cell day-header">{{ day }}</div>
          }

          <!-- Time Slots -->
          @for (timeSlot of timeSlots(); track timeSlot) {
            <div class="calendar-cell time-cell">{{ timeSlot }}</div>

            @for (day of visibleDays(); track day) {
              <div class="calendar-cell slot-cell" (click)="onSlotClick(day, timeSlot)">
                @for (item of getItemsInSlot(day, timeSlot); track item.id) {
                    <div
                      class="schedule-item"
                      [class.course-item]="item.type === 'course'"
                      [class.event-item]="item.type === 'event'"
                      [style.background]="
                        item.color
                          ? 'linear-gradient(135deg, ' +
                            item.color +
                            ' 0%, ' +
                            item.color +
                            'dd 100%)'
                          : null
                      "
                      [style.grid-row]="'span ' + calculateItemSpan(item)"
                      (click)="onItemClick(item, $event)"
                    >
                      <div class="item-content">
                        <div class="item-header">
                            <span class="item-title">{{ item.title }}</span>
                            @if (item.type === 'course' && getCourseDifficulty(item.id)) {
                                <span class="difficulty-badge" [class]="getDifficultyClass(getCourseDifficulty(item.id)!)">
                                    {{ getCourseDifficulty(item.id) }}
                                </span>
                            }
                        </div>
                        @if (item.instructor) {
                          <div class="item-subtitle">{{ item.instructor }}</div>
                        }
                        @if (item.description && !item.instructor) {
                          <div class="item-subtitle">{{ item.description }}</div>
                        }
                        <div class="item-time">{{ item.startTime }} - {{ item.endTime }}</div>
                      </div>
                    </div>
                }
              </div>
            }
          }
        </div>
      </div>
      
      <!-- Right Sidebar for Analysis & Untimed -->
      <aside class="right-sidebar">
        <!-- Analysis Panel -->
        <div class="analysis-panel" *ngIf="showAnalyzer() || analyzing() || isGeneratedMode() || (schedule()?.difficultyScore && schedule()?.difficultyScore! > 0)">
            <div class="panel-header">
                <h3>Schedule Analysis</h3>
                @if (analyzing()) {
                    <span class="loading-spinner">‚ü≥</span>
                }
            </div>
            
            @if (schedule()?.difficultyScore) {
                <div class="score-cards">
                    <div class="score-card main-score" [class]="getDifficultyClass(schedule()?.difficultyScore!)">
                        <div class="score-value">{{ schedule()?.difficultyScore | number:'1.0-0' }}</div>
                        <div class="score-label">Difficulty</div>
                    </div>
                    <div class="score-card">
                        <div class="score-value">{{ schedule()?.weeklyHours | number:'1.1-1' }}</div>
                        <div class="score-label">Hours/Wk</div>
                    </div>
                    <div class="score-card">
                        <div class="score-value">{{ schedule()?.creditHours }}</div>
                        <div class="score-label">Credits</div>
                    </div>
                </div>

                @if (schedule()?.gradingDetails?.summary) {
                    <div class="analysis-summary">
                        <h4>Summary</h4>
                        <p>{{ schedule()?.gradingDetails?.summary }}</p>
                    </div>
                }
            } @else if (analyzing()) {
                <div class="analyzing-state">
                    <p>Analyzing schedule difficulty and workload...</p>
                </div>
            } @else {
                <div class="empty-state">
                    <p>Click "Analyze" to see difficulty scores.</p>
                </div>
            }
        </div>

        <!-- Untimed Courses -->
        <div class="untimed-courses" *ngIf="getUntimedCourses().length > 0">
          <h3>Untimed Courses</h3>
          <ul>
            <li
              *ngFor="let course of getUntimedCourses()"
              class="untimed-course"
              (click)="editCourse(course)"
            >
              <span class="course-courseId">{{ course.courseId }}</span>
            </li>
          </ul>
        </div>
      </aside>
    </div>
  }

  <!-- Course Dialog -->
  @if (showCourseDialog()) {
    <div class="dialog-overlay" (click)="closeCourseDialog()">
      <div class="dialog-content" (click)="$event.stopPropagation()">
        <app-course-dialog
          [course]="editingCourse()"
          [campus]="selectedCampus()"
          [term]="selectedTerm()"
          (save)="saveCourse($event)"
          (delete)="deleteCourse($event)"
          (cancel)="closeCourseDialog()"
        >
        </app-course-dialog>
      </div>
    </div>
  }

  <!-- Event Dialog -->
  @if (showEventDialog()) {
    <div class="dialog-overlay" (click)="closeEventDialog()">
      <div class="dialog-content" (click)="$event.stopPropagation()">
        <app-event-dialog
          [event]="editingEvent()"
          (save)="saveEvent($event)"
          (delete)="deleteEvent($event)"
          (cancel)="closeEventDialog()"
        >
        </app-event-dialog>
      </div>
    </div>
  }

  <!-- Success Message -->
  @if (showSuccessMessage()) {
    <div class="success-toast">‚úì Schedule saved successfully!</div>
  }
</div>
